<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Weather Table</title>

    <link href="https://fonts.googleapis.com/css?family=Aldrich" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.grey-indigo.min.css" />

    <style>

        body {
            font-family: 'Aldrich', sans-serif;
            margin: 0;
        }

        canvas { width: 100%; height: 100% }

        h1 {
            font-size: 20px;
            line-height: 20px;
            margin: 0;
            color: white;
        }

        .floating {

            position: absolute;
            padding: 0px 20px;

        }

        .navigator {
            padding-top: 20px;
            bottom: 30px;
            right: 0px;
            z-index: 9999;
        }

        .navigator .create {
            text-align: right;
        }

        .left {
            text-align: left;
        }


    </style>

</head>
<body>

    <div id="Stats-output">

    <div id="app">

        <ul v-if="place_index != null" class="floating demo-list-item mdl-list left">
            <li class="mdl-list__item">
              <span class="mdl-list__item-primary-content">
                <b>[[ places[place_index].name ]]</b>
              </span>
            </li>
            <li class="mdl-list__item">
              <span class="mdl-list__item-primary-content">
                    [[ weathers.weather_str[place_index] ]]
              </span>
            </li>
            <li class="mdl-list__item">
              <span class="mdl-list__item-primary-content">
                    TEMP: [[ weathers.temp[place_index] ]]
              </span>
            </li>
            <li class="mdl-list__item">
              <span class="mdl-list__item-primary-content">
                    TEMP MAX: [[ weathers.temp_max[place_index] ]]
              </span>
            </li>
            <li class="mdl-list__item">
              <span class="mdl-list__item-primary-content">
                    TEMP MIN: [[ weathers.temp_min[place_index] ]]
              </span>
            </li>
            <li class="mdl-list__item">
              <span class="mdl-list__item-primary-content">
                    HUMIDITY: [[ weathers.humidity[place_index] ]]
              </span>
            </li>
            <li class="mdl-list__item">
                <span class="mdl-list__item-primary-content">
                        RAIN: [[ weathers.rain[place_index] ]]
                </span>
            </li>
            <li class="mdl-list__item">
                <span class="mdl-list__item-primary-content">
                        WIND SPEED: [[ weathers.wind_speed[place_index] ]]
                </span>
            </li>
            <li class="mdl-list__item">
                <span class="mdl-list__item-primary-content">
                        WIND DEGREE: [[ weathers.wind_deg[place_index] ]]
                </span>
            </li>
        </ul>

        <section class="floating navigator">
    
            <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp">
                <tbody>
                    <tr>
                        <td v-if="time > 0">[[ time * 3 ]] h later</td>
                        <td v-else>Now</td>
                        <td><input id="time" class="mdl-slider mdl-js-slider" type="range" min="0" :max="10" v-model="time" tabindex="0"></td>
                    </tr>
                </tbody>
            </table>
                        
        </section>

        <div id="canvas">

        </div>
    </div>

</body>


<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/99/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>

<script src="/static/js/lib/OrbitControls.js"></script>

<script type="module">

import {PointCloud} from "/static/js/lib/pointcloud.js";
import {createWeatherTable} from "/static/js/lib/api.js";

(function() {

    var app = new Vue({
        el: '#app',
        data: {
            time: 0,
            point_clouds: [],
            places: [],
            weathers: [],
            place_index: null
        },
        watch: {

            time: function (newValue, oldValue) {

                this.create(null)

            },

        },
        methods: {
            create: function (event) {   
            
                createWeatherTable(this.time, function(response) {

                    app.places   = response.data.places
                    app.weathers = JSON.parse(response.data.weathers)
                    const hasPc = app.point_clouds.length > 0

                    for (let i = 0; i < response.data.point_clouds.length; i++) {

                        const pcData = response.data.point_clouds[i]
                        const place  = app.places[i]

                        const pos = latLongToVector3(place.coord.lat, place.coord.lon, 650)
            
                        if (hasPc) {

                            const pc = app.point_clouds[i]
                            pc.update(pcData)
                            pc.rotate(-1.4, 0.8, 0.0)

                        } else {

                            const pc = new PointCloud(pcData, 65, 2.0, 0xff0044)
                            pc.move(pos.x, pos.y, pos.z)
                            pc.add(scene)
                            pc.rotate(-1.4, 0.8, 0.0)
                            pc.point.name = i

                            app.point_clouds.push(pc)
                        }

                    }
            
                }, function(error) {
            
                })

            }
        },
        delimiters: ['[[',']]']
    })

    app.create()

    // couple of constants
    var POS_X = 0;
    var POS_Y = 0;
    var POS_Z = 1800;
    var WIDTH = 1000;
    var HEIGHT = 600;

    var FOV = 45;
    var NEAR = 1;
    var FAR = 4000;

    // some global variables and initialization code
    // simple basic renderer
    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight)
    canvas.appendChild(renderer.domElement)

    // setup a camera that points to the center
    let camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000)
    camera.position.set(POS_X,POS_Y, POS_Z);
    camera.lookAt(new THREE.Vector3(0,0,0));

    var scene = new THREE.Scene();
    scene.add(camera);

    //scene.background = new THREE.Color( 0x000000 );
    scene.background = new THREE.Color( 0xffffff );

    var spGeo = new THREE.SphereGeometry(630,50,50);
    var planetTexture = THREE.ImageUtils.loadTexture('/static/earth_specular_2048.jpg')
    var mat2 =  new THREE.MeshPhongMaterial( {
        map: planetTexture,
        shininess: 0.9 } )
    const sp = new THREE.Mesh(spGeo, mat2)
    scene.add(sp)


    let light = new THREE.AmbientLight(0xffffff);
    scene.add( light )

    const raycaster = new THREE.Raycaster()

    function latLongToVector3(lat, lon, radius) {
        var phi = (lat)*Math.PI/180
        var theta = (lon-180)*Math.PI/180
 
        var x = -(radius) * Math.cos(phi) * Math.cos(theta)
        var y = (radius) * Math.sin(phi)
        var z = (radius) * Math.cos(phi) * Math.sin(theta)
 
        return new THREE.Vector3(x,y,z)
    }

    const controls = new THREE.OrbitControls(camera, canvas)

    function render() {

        controls.update();

        renderer.render(scene, camera)
        requestAnimationFrame(render)
    }

    render()

    window.addEventListener('mousedown', onDocumentMouseDown, false)
    function onDocumentMouseDown(event) {

        //event.preventDefault()

        if (app.point_clouds.length == 0) { return }

        let rayReceiveObjects = []

        app.point_clouds.forEach(function(pc, i) {

            rayReceiveObjects.push(pc.point)
        })

        let mouse = new THREE.Vector2()

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1

        raycaster.setFromCamera( mouse, camera )
        const intersects = raycaster.intersectObjects( rayReceiveObjects )

        if (intersects.length > 0) {

            const id = intersects[0].object.name
            app.place_index = id

            app.point_clouds.forEach(function(pc, i) {

                const color = i == id ? 0x880022 : 0xff0044

                pc.recolor(color)
            })
            console.log(id)

        }
    }

})()


</script>

</html>
